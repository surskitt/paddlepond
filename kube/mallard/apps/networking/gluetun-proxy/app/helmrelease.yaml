---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gluetun-proxy
  namespace: networking
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 4.6.2
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 3
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
    cleanupOnFail: true
  uninstall:
    keepHistory: false
  values:
    # defaultPodOptions:
    #   securityContext:
    #     runAsUser: 1000
    #     runAsGroup: 1000
    #     fsGroup: 1000
    #     fsGroupChangePolicy: OnRootMismatch
    controllers:
      gluetun:
        containers:
          # coredns:
          #   image:
          #     repository: mirror.gcr.io/coredns/coredns
          #     tag: 1.12.0
          #   args:
          #     - -conf
          #     - /etc/coredns/Corefile
          #   restartPolicy: Always
          #   securityContext:
          #     runAsUser: 1000
          #     runAsGroup: 1000
          #     fsGroup: 1000
          #     fsGroupChangePolicy: OnRootMismatch
          gluetun:
            # dependsOn:
            #   - coredns
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: v3.41.0
            env:
              DOT: "off"
              # DNS_ADDRESS: "127.0.0.2"
              VPN_SERVICE_PROVIDER: airvpn
              VPN_TYPE: wireguard
              VPN_INTERFACE: wg0
              FIREWALL_INPUT_PORTS: "8388,8888,9999"
              # FIREWALL_OUTBOUND_SUBNETS: 10.42.0.0/16,10.43.0.0/16 # Allow access to k8s subnets
              HEALTH_SERVER_ADDRESS: ":9999"
              HTTPPROXY: "on"
              HTTPPROXY_LISTENING_ADDRESS: :8888
              HTTPPROXY_LOG: "on"
              # FIREWALL_VPN_INPUT_PORTS: &proxy-port 8388
              # SERVER_COUNTRIES: United Kingdom,Netherlands,Germany,Switzerland
              SERVER_NAMES: Dalim,Menkent,Piautos,Alpherg,Xuange
            envFrom:
              - secretRef:
                  name: gluetun-proxy
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 9999
                  timeoutSeconds: 10
                  periodSeconds: 30
                  failureThreshold: 5
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 9999
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  failureThreshold: 5
            # restartPolicy: Always
            securityContext:
              capabilities:
                add:
                  - NET_ADMIN
              # allowPrivilegeEscalation: false
    service:
      app:
        controller: gluetun
        type: LoadBalancer
        loadBalancerIP: 192.168.50.105
        annotations:
          "coredns.io/hostname": "gluetun.${SECRET_DOMAIN}"
        ports:
          http:
            port: 8888
    # persistence:
    #   coredns:
    #     type: configMap
    #     name: qbittorrent-coredns
    #     advancedMounts:
    #       qbittorrent:
    #         coredns:
    #           - path: /etc/coredns/Corefile
    #             subPath: Corefile
    #             readOnly: true
